<%+header%>
<!--
    TrustNode FPGA statistics plugin ulbricht@innoroute.de 2018
-->
<style>

</style>
<h2><a name="content">RX/<font color="red">TX</font> drop/bad counters</a></h2>

<div>
<div id="drop_matrix_location"></div>
</div>
<script>
var portcount=32;
var hc_portcount=12;
var reasoncount=32;
DPcount=2;
function create_inout_rx_matrix(){

    var i;
    var j;
    var k;
    var x = document.createElement("table");
    x.setAttribute("id", "drop_matrix");
    x.setAttribute("border", "1");
    x.setAttribute("style","float:left;width:49%;border-collapse: separate;border: 1px solid black;font-size:3hmin;border-spacing: 0px;max-width:100%;white-space:nowrap");
    document.getElementById("drop_matrix_location").appendChild(x);
    for (i = 0; i < portcount+1; i++){
    	if(i){
    	var y = document.createElement("TR");
    	y.setAttribute("id", "drop_matrix_TR"+String(i-1));
    	y.setAttribute("style","font-size:3hmin;border: 1px solid black");
    	document.getElementById("drop_matrix").appendChild(y);
    	}
    else{
    var y = document.createElement("TR");
    	y.setAttribute("id", "drop_matrix_TR_border"+String(i));
    	y.setAttribute("style","font-size:3hmin;border: 1px solid black");
    	document.getElementById("drop_matrix").appendChild(y);
    
    }
    	for (j = 0; j < DPcount+1; j++){
    		if((i>0)&&(j>0)){
	    		var z = document.createElement("TD");
	    		z.setAttribute("id", "drop_matrix_TD"+String(j-1));
	    		z.setAttribute("border", "5");
	    		var t = document.createElement("DIV"); //<div id="inout_rx_matrix'+String(i)+","+String(j)+'"></div>
	    		t.setAttribute("id", "drop_matrix_cell"+String(i-1)+","+String(j-1));
	    		t.setAttribute("border", "5");
	    		for (k = 0; k < reasoncount; k++){
	    		    d=document.createElement("DIV");
	    		    d.setAttribute("id", "dropreason_port"+String(i-1)+"dp"+String(j-1)+"reason"+String(k));
	    		    d.innerHTML="0";
	    		    t.appendChild(d);
	    		}
	    		z.appendChild(t);
	    		document.getElementById("drop_matrix_TR"+String(i-1)).appendChild(z);
	    		
    		}else{
	    		var z = document.createElement("TD");
	    		z.setAttribute("id", "drop_matrix_TD_border"+String(j));
	    		z.setAttribute("border", "5");
	    		var t = document.createElement("DIV"); //<div id="inout_rx_matrix'+String(i)+","+String(j)+'"></div>
	    		t.setAttribute("id", "drop_matrix_cell_border"+String(i)+","+String(j));
	    		t.setAttribute("border", "5");
	    		if(j)t.innerHTML="DP"+String(j-1);
	    		if(i)t.innerHTML="Port"+String(i-1);
	    		z.appendChild(t);
	    		if(i==0)document.getElementById("drop_matrix_TR_border"+String(i)).appendChild(z);else document.getElementById("drop_matrix_TR"+String(i-1)).appendChild(z);
    		
    		}
    		
    }  
    }
    
x = document.createElement("table");
    x.setAttribute("id", "hc_matrix");
    x.setAttribute("border", "1");
    x.setAttribute("style","float:right;width:49%;border-collapse: separate;border: 1px solid black;font-size:3hmin;border-spacing: 0px;max-width:100%;white-space:nowrap");
    document.getElementById("drop_matrix_location").appendChild(x);
    for (i = 0; i < hc_portcount+1; i++){
    	if(i){
    	var y = document.createElement("TR");
    	y.setAttribute("id", "hc_matrix_TR"+String(i-1));
    	y.setAttribute("style","font-size:3hmin;border: 1px solid black");
    	document.getElementById("hc_matrix").appendChild(y);
    	}
    else{
    var y = document.createElement("TR");
    	y.setAttribute("id", "hc_matrix_TR_border"+String(i));
    	y.setAttribute("style","font-size:3hmin;border: 1px solid black");
    	document.getElementById("hc_matrix").appendChild(y);
    
    }
    	for (j = 0; j < 1+1; j++){
    		if((i>0)&&(j>0)){
	    		var z = document.createElement("TD");
	    		z.setAttribute("id", "hc_matrix_TD"+String(j-1));
	    		z.setAttribute("border", "5");
	    		var t = document.createElement("DIV"); //<div id="inout_rx_matrix'+String(i)+","+String(j)+'"></div>
	    		t.setAttribute("id", "hc_matrix_cell"+String(i-1)+","+String(j-1));
	    		t.setAttribute("border", "5");
	    		for (k = 0; k < reasoncount; k++){
	    		    d=document.createElement("DIV");
	    		    d.setAttribute("id", "dropreason_hc"+String(i-1)+"reason"+String(k));
	    		    d.innerHTML="0";
	    		    t.appendChild(d);
	    		}
	    		z.appendChild(t);
	    		document.getElementById("hc_matrix_TR"+String(i-1)).appendChild(z);
	    		
    		}else{
	    		var z = document.createElement("TD");
	    		z.setAttribute("id", "hc_matrix_TD_border"+String(j));
	    		z.setAttribute("border", "5");
	    		var t = document.createElement("DIV"); //<div id="inout_rx_matrix'+String(i)+","+String(j)+'"></div>
	    		t.setAttribute("id", "hc_matrix_cell_border"+String(i)+","+String(j));
	    		t.setAttribute("border", "5");
	    		if(j)t.innerHTML="Header creation counters";
	    		if(i)t.innerHTML="HC_port"+String(i-1);
	    		z.appendChild(t);
	    		if(i==0)document.getElementById("hc_matrix_TR_border"+String(i)).appendChild(z);else document.getElementById("hc_matrix_TR"+String(i-1)).appendChild(z);
    		
    		}
    		
    }  
    }
x = document.createElement("table");
    x.setAttribute("id", "hc_pci_matrix");
    x.setAttribute("border", "1");
    x.setAttribute("style","float:right;width:49%;border-collapse: separate;border: 1px solid black;font-size:3hmin;border-spacing: 0px;max-width:100%;white-space:nowrap");
    document.getElementById("drop_matrix_location").appendChild(x);
    for (i = 0; i < 2+1; i++){
    	if(i){
    	var y = document.createElement("TR");
    	y.setAttribute("id", "hc_pci_matrix_TR"+String(i-1));
    	y.setAttribute("style","font-size:3hmin;border: 1px solid black");
    	document.getElementById("hc_pci_matrix").appendChild(y);
    	}
    else{
    var y = document.createElement("TR");
    	y.setAttribute("id", "hc_pci_matrix_TR_border"+String(i));
    	y.setAttribute("style","font-size:3hmin;border: 1px solid black");
    	document.getElementById("hc_pci_matrix").appendChild(y);
    
    }
    	for (j = 0; j < 1+1; j++){
    		if((i>0)&&(j>0)){
	    		var z = document.createElement("TD");
	    		z.setAttribute("id", "hc_pci_matrix_TD"+String(j-1));
	    		z.setAttribute("border", "5");
	    		var t = document.createElement("DIV"); //<div id="inout_rx_matrix'+String(i)+","+String(j)+'"></div>
	    		t.setAttribute("id", "hc_pci_matrix_cell"+String(i-1)+","+String(j-1));
	    		t.setAttribute("border", "5");
	    		for (k = 0; k < reasoncount; k++){
	    		    d=document.createElement("DIV");
	    		    d.setAttribute("id", "dropreason_pci"+String(i-1)+"reason"+String(k));
	    		    d.innerHTML="0";
	    		    t.appendChild(d);
	    		}
	    		z.appendChild(t);
	    		document.getElementById("hc_pci_matrix_TR"+String(i-1)).appendChild(z);
    		}else{
	    		var z = document.createElement("TD");
	    		z.setAttribute("id", "hc_pci_matrix_TD_border"+String(j));
	    		z.setAttribute("border", "5");
	    		var t = document.createElement("DIV"); //<div id="inout_rx_matrix'+String(i)+","+String(j)+'"></div>
	    		t.setAttribute("id", "hc_pci_matrix_cell_border"+String(i)+","+String(j));
	    		t.setAttribute("border", "5");
	    		if(j)t.innerHTML="PCI header creation counters";
	    		if(i)t.innerHTML="HC_PCI"+String(i-1);
	    		z.appendChild(t);
	    		if(i==0)document.getElementById("hc_pci_matrix_TR_border"+String(i)).appendChild(z);else document.getElementById("hc_pci_matrix_TR"+String(i-1)).appendChild(z);
    		
    		}
    		
    }  
    }

}
function update_port_matrix(json_data){
var i;
var stat = JSON.parse(json_data);
for (i = 0; i < portcount; i++){
	rx_val=Number(stat["dp0#rx#"+String(i)]);
	tx_val=Number(stat["dp0#tx#"+String(i)]);
	document.getElementById("port-label-"+String(i)+"-right").textContent="Port"+String(i)+"(TX:"+String(tx_val)+")";
	document.getElementById("port-label-"+String(i)+"-left").textContent="Port"+String(i)+"(RX:"+String(rx_val)+")";
}


}
function update_inout_rx_matrix(json_data){
    var i;
    var j;
    var k;
    for (i = 0; i < portcount; i++){for (j = 0; j < DPcount; j++){for (k = 0; k < reasoncount; k++){
        document.getElementById("dropreason_port"+String(i)+"dp"+String(j)+"reason"+String(k)).setAttribute("visibility", "hidden");
    } 
    }    
    }
}

function updatestatistics(){
//getstatistics('source /usr/share/InnoRoute/tn_env.sh && TNbar1 $(($C_BASE_ADDR_STATISTICS_RX_BADRSN_LOWER_0*$C_BASE_ADDR_FACTOR+0)) | cut -d " " -f 6')
//getstatistics("$C_BASE_ADDR_STATISTICS_RX_BADRSN_LOWER_0","0","0","result");
//getstatistics("$C_BASE_ADDR_RTC","$C_SUB_ADDR_RTC_BRIDGE_LOW","0","rtc-value");
getstatistics();
setTimeout(updatestatistics, 1000);
}

function getstatistics() {
	//var cmd="source /usr/share/InnoRoute/tn_env.sh && TNbar1 $(("+base+"*$C_BASE_ADDR_FACTOR+"+sub+"+"+offset+')) | cut -d " " -f 6';
	//console.log(cmd);
	(new XHR()).post("<%=luci.dispatcher.build_url("admin", "trustnode", "TNstatisticsupdate")%>", {"cmd":"io_counters"}, function(x) {
        update_inout_rx_matrix(x.response);	
        });
        (new XHR()).post("<%=luci.dispatcher.build_url("admin", "trustnode", "TNstatisticsupdate")%>", {"cmd":"port_counters"}, function(y) {
        update_port_matrix(y.response);	
        });
    return false;
}
//setInterval(updatestatistics, 1000);
create_inout_rx_matrix();
setTimeout(updatestatistics, 1000);
</script>
<%+footer%>

