#!/bin/bash
#AD9558 load config script
#Phillip Dockhorn, Marian Ulbricht Innoroute GmbH 2016
#{dockhorn,ulbricht}@innoroute.de

cmd=''

pllctl 0x69 0x00 0x32 #reset
#pllctl 0x69 0xa01 0x20
pllctl 0x69 0xa02 0x02
pllctl 0x69 0x405 0x20

while read stp; do
  	if [[ $stp =~ 0x(.{1,3}),.+0x(.{1,3}), ]];then
  		reg=${BASH_REMATCH[1]}
 		val=${BASH_REMATCH[2]}
 		regd=$((16#$reg)) 
 		vald=$((16#$val))
 		#echo
		if [[ "0x$reg" -eq 0x400 ]];then
		pllctl 0x69  0x5 0x1
		fi
		if [[ "0x$reg" -lt 0xE00 ]];then #ignore eeprom data
			pllctl 0x69 $reg $val
 			#echo "write $val ($vald) to $reg ($regd)"
 			#echo $regd,$vald >> bla
 			sleep 0.0001
		fi
 	fi
done <$1

#pllctl 0x69 Ã0x5 0x1

pllctl 0x69 0x405 0x21 #sync reset
#pllctl 0x69 0x403 0x07 #polefilter default
pllctl 0x69 0x400 0x81 #chargepump current default
pllctl 0x69 0x5 0x1 #ioupdate
#pllctl 0x69 0xa01 1b #override refselect to refD manual
pllctl 0x69 0x5 0x1 #ioupdate
pllctl 0x69 0x500 0xf2 #overrride syncmode to sync on dpll_pase
pllctl 0x69 0x5 0x1 #ioupdate

if [ "$#" -gt 1 ] ;then
        if [ $2 == "E" ] ;then
        echo "storing in eeprom..."
        pllctl 0x69 0xe00 0x1
        pllctl 0x69 0xe02 0x1
        sleep 2
        pllctl 0x69 0xe00 0x0
        fi
fi

sleep 2

echo "calibrating VCO"
pllctl  0x69 0x0405 0x20
pllctl  0x69 0x0005 0x01
pllctl  0x69 0x0405 0x21
pllctl  0x69 0x0005 0x01 #calibate vco

echo "sync output"
pllctl  0x69 0x500 0xf4 #snyc
pllctl  0x69 0x0A02 0x02
pllctl  0x69 0x0005 0x01
pllctl  0x69 0x0A02 0x00
pllctl  0x69 0x0005 0x01

echo "status"
pllctl  0x69 0x0D01

echo "done"
